import{r as o,q as Y,y as G,j as d}from"./app-B_yDXGb1.js";import{g as u}from"./utils-Bh--IV6R.js";import{u as a}from"./store-BKG3t3Ux.js";import _ from"./StandardQuestionNode-C7GCvbXb.js";import $ from"./StandardResultNode-DqUPslOl.js";import{D as z}from"./core.esm-z330JrOt.js";import h from"./Draggable-DTzecJWP.js";import J from"./Droppable-CHpSrX24.js";import{u as K,b as Z,c as ee,r as te,d as oe,i as ne,C as se,S as re,e as de,f as ae,h as ce}from"./index-ztlPLrEG.js";/* empty css             *//* empty css                           */import"./react-Cr7_OnYh.js";import"./ChoiceSourceHandle-DptY8hYu.js";import"./QuestionSubMenu-CYzptjjw.js";import"./index-4BYW9ckQ.js";import"./constants-C6cNm0Qv.js";import"./index-ZFDB3trd.js";import"./iconBase-DxKZmQ9Q.js";import"./index-C9YUlD84.js";import"./ResultSubMenu-G_gfXcXC.js";const ie=({initialNodes:l,initialEdges:b,defaultViewport:x})=>{const[y,m]=o.useState(l),[C,r]=o.useState(b),c=o.useRef(!0),p=a(e=>e.isDirty),i=a(e=>e.setIsDirty),k=a(e=>e.setFirstNodeId),S=a(e=>e.qNodeNum),E=a(e=>e.setQnodeNum),R=a(e=>e.addQnodeNum),j=a(e=>e.rNodeNum),w=a(e=>e.setRnodeNum),D=a(e=>e.addRnodeNum),{screenToFlowPosition:q,addNodes:g,setViewport:le,getNodes:Q}=K(),{url:F}=Y(),I=o.useMemo(()=>({qNode:_,rNode:$}),[]);o.useEffect(()=>{E(l.filter(e=>e.type==="qNode").length),w(l.filter(e=>e.type==="rNode").length)},[]),o.useEffect(()=>{const e=G.on("before",t=>{const n=t.detail.visit;return n.url.pathname===F&&n.method==="post"?!0:p?confirm("変更が保存されていませんがページを離れてもよろしいですか？"):!0});return()=>{e()}},[p]);const M=o.useCallback(e=>{m(t=>Z(e,t)),i(!0)},[m,i]),T=o.useCallback(e=>{r(t=>ee(e,t)),i(!0)},[r,i]),A=e=>{const t=u(),n=u();Q().filter(s=>s.type==="qNode").length===0&&k(t),g({id:t,data:{topic:"",choices:[{id:n,content:""}]},position:e,type:"qNode",dragHandle:".dhandle"}),R(1)},v=e=>{const t=u();g({id:t,data:{result:""},position:e,type:"rNode",dragHandle:".dhandle"}),D(1)},L=o.useCallback(({active:e,over:t,delta:n,activatorEvent:s})=>{if(!(t==null||t.id!="droppableArea")&&s instanceof MouseEvent){const W=s.pageX+n.x,X=s.pageY+n.y,f={x:30,y:20},N=q({x:W-f.x,y:X-f.y});e.id==="draggable-question"&&A(N),e.id==="draggable-result"&&v(N)}},[]),O=o.useCallback((e,t)=>{e.source===t.target||t.source===e.target||(c.current=!0,r(n=>te(e,t,n)))},[]),B=o.useCallback(()=>{c.current=!1},[]),H=o.useCallback(e=>{c.current||r(t=>t.filter(n=>n.id!==e.id)),c.current=!0},[]),P=o.useCallback(e=>{e.source!==e.target&&r(t=>oe({...e,type:"smoothstep"},t))},[r]),U=o.useCallback((e,t)=>{r(n=>n.map(s=>s.id===t.id?{...s,animated:!s.animated,style:s.animated?{stroke:"gray",strokeWidth:2}:{stroke:"gold",strokeWidth:3}}:{...s,animated:!1,style:{}}))},[r]),V=o.useCallback((e,t)=>{e.preventDefault(),r(n=>n.filter(s=>s.id!==t.id))},[r]);return d.jsx("div",{className:"grow w-full flex",children:d.jsxs(z,{onDragEnd:L,children:[d.jsxs("div",{className:"h-full w-[5%] flex items-center flex-col gap-y-10 pt-12 bg-slate-800",children:[d.jsx(h,{id:"draggable-question",label:"質問",color:"indigo",nodeNum:S,maxNodeNum:15}),d.jsx(h,{id:"draggable-result",label:"結果",color:"orange",nodeNum:j,maxNodeNum:10})]}),d.jsx(J,{id:"droppableArea",children:d.jsxs(ne,{nodes:y,edges:C,nodeTypes:I,onNodesChange:M,onEdgesChange:T,snapToGrid:!0,connectionLineType:se.SmoothStep,onReconnect:O,onReconnectStart:B,onReconnectEnd:(e,t)=>H(t),onConnect:P,onEdgeClick:U,onEdgeContextMenu:V,elevateEdgesOnSelect:!0,defaultViewport:x,panOnScroll:!0,elementsSelectable:!0,selectionMode:re.Partial,children:[d.jsx(de,{color:"#222",variant:ae.Lines,gap:20}),d.jsx(ce,{})]})})]})})},Fe=o.memo(ie);export{Fe as default};
