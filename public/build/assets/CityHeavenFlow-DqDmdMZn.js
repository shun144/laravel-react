import{r as o,q as X,y as Y,j as d}from"./app-BMXDJVyd.js";import{g as u}from"./utils-D5TGypcN.js";import{u as a}from"./store-C-TAy8r_.js";import G from"./CityHeavenQuestionNode-DN81cXYA.js";import _ from"./CityHeavenResultNode-CkVx6zfk.js";import{D as $}from"./core.esm-hzQN0OPo.js";import N from"./Draggable-Yc4YLlN1.js";import z from"./Droppable-D7przk0G.js";import{u as J,b as K,c as Z,r as ee,d as te,i as oe,C as ne,S as se,e as re,f as de,h as ae}from"./index-DYGodSJL.js";/* empty css             *//* empty css                           */import"./react-BQFNYpn0.js";import"./ChoiceSourceHandle-BMumkVGJ.js";import"./index-BL9t5Psi.js";import"./iconBase-DyeLHBi8.js";import"./index-CdkyqLyN.js";import"./SalesPointSelect-DObHn_wG.js";import"./floating-ui.dom-D0k0YRlw.js";import"./QuestionSubMenu-D_Tdl26P.js";import"./index-Ch_NWwRx.js";import"./ResultSubMenu-j6blb3kN.js";import"./react-tooltip.min-DZcZWJaY.js";const ie=({initialNodes:c,initialEdges:C,defaultViewport:h})=>{const[b,m]=o.useState(c),[y,r]=o.useState(C),i=o.useRef(!0),p=a(e=>e.isDirty),l=a(e=>e.setIsDirty),x=a(e=>e.setFirstNodeId),k=a(e=>e.qNodeNum),E=a(e=>e.setQnodeNum),R=a(e=>e.addQnodeNum),w=a(e=>e.rNodeNum),S=a(e=>e.setRnodeNum),j=a(e=>e.addRnodeNum),{screenToFlowPosition:D,addNodes:g,setViewport:le,getNodes:q}=J(),{url:v}=X(),Q=o.useMemo(()=>({qNode:G,rNode:_}),[]);o.useEffect(()=>{E(c.filter(e=>e.type==="qNode").length),S(c.filter(e=>e.type==="rNode").length)},[]),o.useEffect(()=>{const e=Y.on("before",t=>{const n=t.detail.visit;return n.url.pathname===v&&n.method==="post"?!0:p?confirm("変更が保存されていませんがページを離れてもよろしいですか？"):!0});return()=>{e()}},[p]);const F=o.useCallback(e=>{m(t=>K(e,t)),l(!0)},[m,l]),H=o.useCallback(e=>{r(t=>Z(e,t)),l(!0)},[r,l]),I=e=>{const t=u(),n=u();q().length===0&&x(t),g({id:t,data:{topic:"",choices:[{id:n,content:"",salePoints:[]}]},position:e,type:"qNode",dragHandle:".dhandle"}),R(1)},M=e=>{const t=u();g({id:t,data:{result:""},position:e,type:"rNode",dragHandle:".dhandle"}),j(1)},T=o.useCallback(({active:e,over:t,delta:n,activatorEvent:s})=>{if(!(t==null||t.id!="droppableArea")&&s instanceof MouseEvent){const V=s.pageX+n.x,W=s.pageY+n.y,f=D({x:V,y:W});e.id==="draggable-question"&&I(f),e.id==="draggable-result"&&M(f)}},[]),A=o.useCallback((e,t)=>{i.current=!0,r(n=>ee(e,t,n))},[]),L=o.useCallback(()=>{i.current=!1},[]),O=o.useCallback(e=>{i.current||r(t=>t.filter(n=>n.id!==e.id)),i.current=!0},[]),P=o.useCallback(e=>{r(t=>te({...e,type:"smoothstep"},t))},[r]),B=o.useCallback((e,t)=>{r(n=>n.map(s=>s.id===t.id?{...s,animated:!s.animated,style:s.animated?{stroke:"gray",strokeWidth:2}:{stroke:"gold",strokeWidth:3}}:{...s,animated:!1,style:{}}))},[r]),U=o.useCallback((e,t)=>{e.preventDefault(),r(n=>n.filter(s=>s.id!==t.id))},[r]);return d.jsx("div",{className:"grow w-full flex",children:d.jsxs($,{onDragEnd:T,children:[d.jsxs("div",{className:"h-full w-[5%] flex items-center flex-col gap-y-10 pt-12 bg-slate-800",children:[d.jsx(N,{id:"draggable-question",label:"質問",color:"indigo",nodeNum:k,maxNodeNum:15}),d.jsx(N,{id:"draggable-result",label:"結果",color:"rose",nodeNum:w,maxNodeNum:10})]}),d.jsx(z,{id:"droppableArea",children:d.jsxs(oe,{nodes:b,edges:y,nodeTypes:Q,onNodesChange:F,onEdgesChange:H,snapToGrid:!0,connectionLineType:ne.SmoothStep,onReconnect:A,onReconnectStart:L,onReconnectEnd:(e,t)=>O(t),onConnect:P,onEdgeClick:B,onEdgeContextMenu:U,elevateEdgesOnSelect:!0,defaultViewport:h,panOnScroll:!0,elementsSelectable:!0,selectionMode:se.Partial,children:[d.jsx(re,{color:"#222",variant:de.Lines,gap:20}),d.jsx(ae,{})]})})]})})},Fe=o.memo(ie);export{Fe as default};
