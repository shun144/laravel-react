import{r as o,j as s}from"./app-CBaPd7Dh.js";import{c as M,g as l}from"./utils-msIn3iWX.js";import{u as i}from"./store-ConNlJHE.js";import U from"./CityHeavenQuestionNode-DRU3yOv1.js";import _ from"./CityHeavenResultNode-BgaEEpvC.js";import{D as P}from"./core.esm-CBHQCpaP.js";import b from"./Draggable-BHBACdYK.js";import X from"./Droppable-kXOIyxWY.js";import{u as Y,a as G,b as $,r as z,c as J,i as K,S as W,C as Z,B as ee,d as te,e as oe}from"./index-CA6-qqYy.js";import{_ as x}from"./index-zA5hlbrA.js";import"./ReactContexify.min-C_hv5uid.js";import"./react-BS7z_O6y.js";import"./ChoiceSourceHandle-DPW45R5Y.js";import"./index-Ul5UeQar.js";import"./iconBase-qhTEtVqC.js";import"./SalesPointSelect-6qpWPZX8.js";import"./FlowMenu-jHFqOC0p.js";const se=({flowId:h,initialNodes:y,initialEdges:C})=>{const[w,ne,N]=Y(y),[R,a,j]=G(C),[c,E]=o.useState(),S=i(e=>e.setFirstNodeId),u=i(e=>e.firstNodeId),p=i(e=>e.flowTitle),m=i(e=>e.flowUrl),r=o.useRef(!0),{screenToFlowPosition:H,addNodes:g,setViewport:ae,getNodes:k,deleteElements:re}=$(),I=o.useMemo(()=>({cityHeavenQuestionNode:U,cityHeavenResultNode:_}),[]),T=o.useMemo(()=>({type:"smoothstep"}),[]),v=e=>{const t=l(),n=l();k().length===0&&S(t),g({id:t,data:{topic:"",choices:[{id:n,content:"",salePoints:[]}]},position:e,type:"cityHeavenQuestionNode",dragHandle:".custom-drag-handle"})},F=e=>{const t=l();g({id:t,data:{result:""},position:e,type:"cityHeavenResultNode",dragHandle:".custom-drag-handle"})},D=o.useCallback(({active:e,over:t,delta:n,activatorEvent:d})=>{if(!(t==null||t.id!="droppableA")&&d instanceof MouseEvent){const B=d.pageX+n.x,L=d.pageY+n.y,f=H({x:B,y:L});e.id==="draggable-question"&&v(f),e.id==="draggable-result"&&F(f)}},[]),Q=o.useCallback(()=>{if(c){const e=c.toObject();(async()=>{try{const t=await M(h,e.nodes,e.edges,u,p,m);x.success("保存しました",{duration:4e3})}catch{x.error("失敗!")}})()}},[c,u,p,m]),A=o.useCallback((e,t)=>{r.current=!0,a(n=>z(e,t,n))},[]),O=o.useCallback(()=>{r.current=!1},[]),V=o.useCallback(e=>{r.current||a(t=>t.filter(n=>n.id!==e.id)),r.current=!0},[]),q=o.useCallback(e=>{a(t=>J(e,t))},[a]);return s.jsx("div",{className:"h-full flex",children:s.jsxs(P,{onDragEnd:e=>D(e),children:[s.jsxs("div",{className:"w-[10%] flex items-center flex-col gap-y-3 py-3 bg-slate-800",children:[s.jsx(b,{id:"draggable-question",label:"質問"}),s.jsx(b,{id:"draggable-result",label:"アンケート終了"}),s.jsx("button",{className:"bg-purple-700 border rounded w-[120px] h-[80px] text-white",onClick:()=>Q(),children:"保存"})]}),s.jsx(X,{id:"droppableA",children:s.jsxs(K,{nodes:w,edges:R,nodeTypes:I,onNodesChange:N,onEdgesChange:j,fitView:!0,fitViewOptions:{padding:.2},snapToGrid:!0,edgeTypes:{smoothstep:W},connectionLineType:Z.SmoothStep,onReconnect:(e,t)=>A(e,t),onReconnectStart:()=>O(),onReconnectEnd:(e,t)=>V(t),onConnect:e=>q(e),onInit:E,defaultEdgeOptions:T,children:[s.jsx(ee,{color:"#222",variant:te.Lines,gap:20}),s.jsx(oe,{})]})})]})})},je=o.memo(se);export{je as default};
