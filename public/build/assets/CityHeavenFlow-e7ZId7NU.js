import{r as o,q as Y,y as G,j as a}from"./app-BJoOWkfI.js";import{g as u}from"./utils-CgtSHtMN.js";import{u as d}from"./store-DP-f8f3k.js";import _ from"./CityHeavenQuestionNode-ycNQdE9q.js";import $ from"./CityHeavenResultNode-BQ4fcLfI.js";import{D as z}from"./core.esm-0zhu5npz.js";import y from"./Draggable-BlxLQgwQ.js";import J from"./Droppable-12BEF3yH.js";import{u as K,b as Z,c as ee,r as te,d as oe,i as ne,C as se,S as re,e as ae,f as de,h as ie}from"./index-BnmHmR98.js";/* empty css             *//* empty css                           */import{q as le,r as ce}from"./constants-DvdQyfvX.js";import"./react-BLAIrpwY.js";import"./ChoiceSourceHandle-CvUXhcpO.js";import"./QuestionSubMenu-DZai5qCE.js";import"./index-B5uugM5x.js";import"./index--M_nDXQu.js";import"./iconBase-BMYX6rd5.js";import"./index-CmtXgrgb.js";import"./SalesPointSelect-DPzv8-oj.js";import"./floating-ui.dom-D0k0YRlw.js";import"./ResultSubMenu-_3aGW7m6.js";const ue=({initialNodes:c,initialEdges:x,defaultViewport:h})=>{const[b,m]=o.useState(c),[C,r]=o.useState(x),i=o.useRef(!0),p=d(e=>e.isDirty),l=d(e=>e.setIsDirty),k=d(e=>e.setFirstNodeId),E=d(e=>e.qNodeNum),R=d(e=>e.setQnodeNum),S=d(e=>e.addQnodeNum),j=d(e=>e.rNodeNum),q=d(e=>e.setRnodeNum),w=d(e=>e.addRnodeNum),{screenToFlowPosition:D,addNodes:f,setViewport:me,getNodes:M}=K(),{url:v}=Y(),Q=o.useMemo(()=>({qNode:_,rNode:$}),[]);o.useEffect(()=>{R(c.filter(e=>e.type==="qNode").length),q(c.filter(e=>e.type==="rNode").length)},[]),o.useEffect(()=>{const e=G.on("before",t=>{const n=t.detail.visit;return n.url.pathname===v&&n.method==="post"?!0:p?confirm("変更が保存されていませんがページを離れてもよろしいですか？"):!0});return()=>{e()}},[p]);const F=o.useCallback(e=>{m(t=>Z(e,t)),l(!0)},[m,l]),H=o.useCallback(e=>{r(t=>ee(e,t)),l(!0)},[r,l]),I=e=>{const t=u(),n=u();M().filter(s=>s.type==="qNode").length===0&&k(t),f({id:t,data:{topic:"",choices:[{id:n,content:"",salePoints:[]}]},position:e,type:"qNode",dragHandle:".dhandle"}),S(1)},T=e=>{const t=u();f({id:t,data:{result:""},position:e,type:"rNode",dragHandle:".dhandle"}),w(1)},A=o.useCallback(({active:e,over:t,delta:n,activatorEvent:s})=>{if(!(t==null||t.id!="droppableArea")&&s instanceof MouseEvent){const W=s.pageX+n.x,X=s.pageY+n.y,g={x:30,y:20},N=D({x:W-g.x,y:X-g.y});e.id==="draggable-question"&&I(N),e.id==="draggable-result"&&T(N)}},[]),L=o.useCallback((e,t)=>{e.source===t.target||t.source===e.target||(i.current=!0,r(n=>te(e,t,n)))},[]),O=o.useCallback(()=>{i.current=!1},[]),P=o.useCallback(e=>{i.current||r(t=>t.filter(n=>n.id!==e.id)),i.current=!0},[]),B=o.useCallback(e=>{e.source!==e.target&&r(t=>oe({...e,type:"smoothstep"},t))},[r]),U=o.useCallback((e,t)=>{r(n=>n.map(s=>s.id===t.id?{...s,animated:!s.animated,style:s.animated?{stroke:"gray",strokeWidth:2}:{stroke:"gold",strokeWidth:3}}:{...s,animated:!1,style:{}}))},[r]),V=o.useCallback((e,t)=>{e.preventDefault(),r(n=>n.filter(s=>s.id!==t.id))},[r]);return a.jsx("div",{className:"grow w-full flex",children:a.jsxs(z,{onDragEnd:A,children:[a.jsxs("div",{className:"h-full w-[5%] flex items-center flex-col gap-y-10 pt-12 bg-slate-800",children:[a.jsx(y,{id:"draggable-question",label:"質問",color:"indigo",nodeNum:E,maxNodeNum:le}),a.jsx(y,{id:"draggable-result",label:"結果",color:"rose",nodeNum:j,maxNodeNum:ce})]}),a.jsx(J,{id:"droppableArea",children:a.jsxs(ne,{nodes:b,edges:C,nodeTypes:Q,onNodesChange:F,onEdgesChange:H,snapToGrid:!0,connectionLineType:se.SmoothStep,onReconnect:L,onReconnectStart:O,onReconnectEnd:(e,t)=>P(t),onConnect:B,onEdgeClick:U,onEdgeContextMenu:V,elevateEdgesOnSelect:!0,defaultViewport:h,panOnScroll:!0,elementsSelectable:!0,selectionMode:re.Partial,children:[a.jsx(ae,{color:"#222",variant:de.Lines,gap:20}),a.jsx(ie,{})]})})]})})},Ie=o.memo(ue);export{Ie as default};
